"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Gravatar = void 0;
const tslib_1 = require("tslib");
const jsx_runtime_1 = require("react/jsx-runtime");
const calypso_url_1 = require("@automattic/calypso-url");
const clsx_1 = tslib_1.__importDefault(require("clsx"));
const react_1 = require("react");
require("./style.scss");
class Gravatar extends react_1.Component {
    static defaultProps = {
        // The REST-API returns s=96 by default, so that is most likely to be cached
        imgSize: 96,
        size: 32,
    };
    state = { failedToLoad: false };
    getResizedImageURL(imageURL) {
        const { imgSize } = this.props;
        const defaultUrl = 'https://www.gravatar.com/avatar/0';
        imageURL = imageURL || defaultUrl;
        const urlType = (0, calypso_url_1.determineUrlType)(imageURL);
        if (urlType === calypso_url_1.URL_TYPE.INVALID || urlType === calypso_url_1.URL_TYPE.PATH_RELATIVE) {
            return defaultUrl;
        }
        const { search, origin, host, ...parsedURL } = (0, calypso_url_1.getUrlParts)(imageURL);
        if (/^([-a-zA-Z0-9_]+\.)*(gravatar.com)$/.test(parsedURL.hostname)) {
            parsedURL.searchParams.set('s', imgSize?.toString() ?? '32');
            parsedURL.searchParams.set('d', 'mm');
        }
        else {
            // assume photon
            parsedURL.searchParams.set('resize', `${imgSize},${imgSize}`);
        }
        // getUrlFromParts can only handle absolute URLs, so add dummy data if needed.
        // formatUrl will remove it away, to match the previous url type.
        parsedURL.protocol = parsedURL.protocol || 'https:';
        parsedURL.hostname = parsedURL.hostname || '__domain__.invalid';
        return (0, calypso_url_1.format)((0, calypso_url_1.getUrlFromParts)(parsedURL), urlType);
    }
    onError = () => this.setState({ failedToLoad: true });
    render() {
        const { alt, title, size, tempImage, user } = this.props;
        if (!user) {
            return (0, jsx_runtime_1.jsx)("span", { className: "gravatar is-placeholder", style: { width: size, height: size } });
        }
        if (this.state.failedToLoad && !tempImage) {
            return (0, jsx_runtime_1.jsx)("span", { className: "gravatar is-missing" });
        }
        const altText = alt || user.display_name || user.name;
        const avatarURL = tempImage || this.getResizedImageURL((0, calypso_url_1.safeImageUrl)(user.avatar_URL));
        const classes = (0, clsx_1.default)('gravatar', this.props.className);
        return ((0, jsx_runtime_1.jsx)("img", { alt: altText, title: title, className: classes, src: avatarURL, width: size, height: size, onError: this.onError }));
    }
}
exports.Gravatar = Gravatar;
//# sourceMappingURL=index.js.map